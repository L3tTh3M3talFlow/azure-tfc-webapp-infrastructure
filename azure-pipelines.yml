# No Terraform logic here — just orchestration.
trigger:
  batch: true
  branches:
    include:
      - dev
  paths:
    include:
      - terraform/**/*.tf
      - terraform/**/*.tfvars

pool:
  vmImage: ubuntu-latest

variables:
  - group: your-terraform-cloud-name
  - name: TF_CLOUD_ORGANIZATION 
    value: yourorg
  - name: TF_WORKSPACE
    value: your-tfc-workspace-name

parameters:
- name: runDestroy
  displayName: '⚠️ Run Terraform Destroy'
  type: boolean
  default: false

stages:
- stage: Validate
  displayName: Terraform Validate
  jobs:
  - template: templates/terraform-validate.yml

- stage: Plan
  displayName: Terraform Plan
  dependsOn: Validate
  jobs:
  - template: templates/terraform-plan.yml

- stage: Apply
  displayName: Terraform Apply (Approval Required)
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - template: templates/terraform-apply.yml

- stage: Destroy
  displayName: Terraform Destroy (Approval Required)
  dependsOn: Validate
  condition: and(succeeded(),eq(${{ parameters.runDestroy }}, true),eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - template: templates/terraform-destroy.yml

